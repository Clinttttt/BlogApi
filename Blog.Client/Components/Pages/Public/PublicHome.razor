@page "/public"
@inject NavigationManager Navigation

<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 h-screen overflow-auto pb-15">

        <!-- Header -->
        <div class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">Developer Learning Journal</h1>
            <p class="text-lg text-gray-600">Sharing my journey through .NET, Blazor, and Modern Web Development</p>
        </div>

        @if (posts == null)
        {
            <!-- Loading State -->
            <div class="flex justify-center items-center py-20">
                <div class="text-center">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
                    <p class="text-gray-600 text-lg">Loading posts...</p>
                </div>
            </div>
        }
        else if (!posts.Any())
        {
            <!-- Empty State -->
            <div class="bg-white rounded-2xl shadow-sm p-12 text-center">
                <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">No posts yet</h3>
                <p class="text-gray-600">Check back soon for new content!</p>
            </div>
        }
        else
        {
            <!-- Posts Feed -->
            <div class="space-y-6">
                @foreach (var post in posts)
                {
                    <article @onclick="() => NavigateToPost(post.Id)"
                             class="bg-white rounded-2xl shadow-sm overflow-hidden hover:shadow-lg transition-all duration-300 cursor-pointer group">

                        <!-- Post Header -->
                        <div class="px-6 pt-6">
                            <div class="flex items-center justify-between mb-4">
                                <span class="inline-block bg-indigo-100 text-indigo-600 px-3 py-1 rounded-full text-sm font-semibold">
                                    @post.CategoryName
                                </span>
                                <span class="text-sm text-gray-500">@post.PostCreatedAt.ToString("MMM dd, yyyy")</span>
                            </div>

                            <h2 class="text-2xl font-bold text-gray-900 mb-3 group-hover:text-indigo-600 transition-colors">
                                @post.Title
                            </h2>

                            <div class="flex items-center gap-4 text-sm text-gray-600 mb-4">
                                <div class="flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                    </svg>
                                    <span>@post.Author</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <span>@post.ReadingDuration</span>
                                </div>
                            </div>
                        </div>

                        <!-- Post Image -->
                        @if (!string.IsNullOrEmpty(post.PhotoPreview))
                        {
                            <div class="w-full h-64 overflow-hidden">
                                <img src="@post.PhotoPreview"
                                     class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                                     alt="@post.Title" />
                            </div>
                        }

                        <!-- Post Excerpt -->
                        <div class="px-6 py-4">
                            <p class="text-gray-700 line-clamp-3 leading-relaxed">
                                @GetExcerpt(post.Content)
                            </p>
                        </div>

                        <!-- Post Footer -->
                        <div class="px-6 pb-6">
                            <div class="flex items-center justify-between pt-4 border-t border-gray-200">
                                <div class="flex items-center gap-6 text-sm text-gray-600">
                                    <div class="flex items-center gap-2">
                                        <svg class="w-5 h-5 @(post.PhotoIsliked ? "fill-red-500 text-red-500" : "")" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                                        </svg>
                                        <span class="font-medium">@post.PostLike</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                        </svg>
                                        <span class="font-medium">@post.CommentCount</span>
                                    </div>
                                </div>

                                <button class="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors group-hover:shadow-md">
                                    Read More
                                    <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                    </svg>
                                </button>
                            </div>

                            <!-- Tags -->
                            @if (post.Tags?.Any() == true)
                            {
                                <div class="flex flex-wrap gap-2 mt-4">
                                    @foreach (var tag in post.Tags.Take(4))
                                    {
                                        <span class="bg-gray-200 px-2.5 py-1 rounded-md text-xs font-medium text-gray-700">
                                            @tag.Name
                                        </span>
                                    }
                                    @if (post.Tags.Count > 4)
                                    {
                                        <span class="bg-gray-200 px-2.5 py-1 rounded-md text-xs font-medium text-gray-700">
                                            +@(post.Tags.Count - 4) more
                                        </span>
                                    }
                                </div>
                            }
                        </div>
                    </article>
                }
            </div>

            <!-- Load More Button -->
            @if (hasMorePosts)
            {
                <div class="text-center mt-8">
                    <p class="text-sm text-gray-600 mb-3">
                        Showing @posts.Count of @totalCount posts
                    </p>
                    <button @onclick="LoadMorePosts"
                            disabled="@isLoadingMore"
                            class="px-8 py-3 bg-white text-indigo-600 border-2 border-indigo-600 rounded-lg font-semibold hover:bg-indigo-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        @if (isLoadingMore)
                        {
                            <span class="flex items-center gap-2">
                                <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Loading...
                            </span>
                        }
                        else
                        {
                            <span>Load More Posts</span>
                        }
                    </button>
                </div>
            }
            else if (posts?.Any() == true)
            {
                <div class="text-center mt-8 py-6">
                    <p class="text-gray-600 font-medium">
                        🎉 You've reached the end! All @totalCount posts loaded.
                    </p>
                </div>
            }
        }
    </div>
</div>

<style>
    .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>

@code {
    private List<PostSummaryDto>? posts;
    private bool hasMorePosts = false;
    private bool isLoadingMore = false;
    private int totalCount = 0;
    private PageRequest pageRequest = new PageRequest { PageNumber = 1, PageSize = 5 };

    public class PageRequest
    {
        public int PageNumber { get; set; } = 1;
        public int PageSize { get; set; } = 5;
    }

    public class PagedResult<T>
    {
        public List<T> Items { get; set; } = new List<T>();
        public int PageNumber { get; set; }
        public int PageSize { get; set; }
        public int TotalCount { get; set; }
        public int TotalPages => (int)Math.Ceiling(TotalCount / (double)PageSize);
        public bool HasPreviousPage => PageNumber > 1;
        public bool HasNextPage => PageNumber < TotalPages;
    }

    // DTO for post summaries (adjust to match your actual DTOs)
    public class PostSummaryDto
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public string Content { get; set; } = string.Empty;
        public string Author { get; set; } = string.Empty;
        public string CategoryName { get; set; } = string.Empty;
        public DateTime PostCreatedAt { get; set; }
        public string ReadingDuration { get; set; } = string.Empty;
        public int PostLike { get; set; }
        public int CommentCount { get; set; }
        public bool PhotoIsliked { get; set; }
        public string? PhotoPreview { get; set; }
        public List<TagDto>? Tags { get; set; }
    }

    public class TagDto
    {
        public string Name { get; set; } = string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadPosts();
    }


    private async Task LoadPosts()
    {
        // Simulate loading
        await Task.Delay(500);

        // SIMULATED - Replace this section with your actual API call:
        // var pagedResult = await PostClient.GetPagedPosts(pageRequest);

        // Simulate database query with pagination (like your backend code)
        var allPosts = GetAllAvailablePosts();
        totalCount = allPosts.Count; // Simulates: await query.CountAsync();

        // Simulates: query.OrderByDescending(s => s.CreatedAt).Skip(...).Take(...)
        var pagedPosts = allPosts
            .OrderByDescending(p => p.PostCreatedAt)
            .Skip((pageRequest.PageNumber - 1) * pageRequest.PageSize)
            .Take(pageRequest.PageSize)
            .ToList();

        // Create PagedResult (simulating what your API returns)
        var pagedResult = new PagedResult<PostSummaryDto>
        {
            Items = pagedPosts,
            PageNumber = pageRequest.PageNumber,
            PageSize = pageRequest.PageSize,
            TotalCount = totalCount
        };

        if (pageRequest.PageNumber == 1)
        {
            // First load - replace posts
            posts = pagedResult.Items;
        }
        else
        {
            // Load more - append to existing posts
            posts ??= new List<PostSummaryDto>();
            posts.AddRange(pagedResult.Items);
        }

        // Check if there are more pages
        hasMorePosts = pagedResult.HasNextPage;

        StateHasChanged();
    }

    private List<PostSummaryDto> GetAllAvailablePosts()
    {
        // Hardcoded sample data - simulating a larger dataset
        return new List<PostSummaryDto>
        {
            new PostSummaryDto
            {
                Id = 1,
                Title = "Getting Started with CQRS and MediatR in .NET",
                Content = "Command Query Responsibility Segregation (CQRS) is a powerful architectural pattern that separates read and write operations into different models. When combined with MediatR, it provides a clean and maintainable way to structure your .NET applications. In this comprehensive guide, we'll explore how to implement CQRS patterns effectively and why they matter for scalable applications.",
                Author = "John Developer",
                CategoryName = "CQRS",
                PostCreatedAt = DateTime.Now.AddDays(-2),
                ReadingDuration = "8 min read",
                PostLike = 124,
                CommentCount = 15,
                PhotoIsliked = false,
                Tags = new List<TagDto>
                {
                    new TagDto { Name = "cqrs" },
                    new TagDto { Name = "mediatr" },
                    new TagDto { Name = ".net-core" },
                    new TagDto { Name = "clean-architecture" }
                }
            },
            new PostSummaryDto
            {
                Id = 2,
                Title = "Building Real-time Applications with SignalR",
                Content = "SignalR makes it incredibly easy to add real-time web functionality to your applications. Whether you're building a chat application, live dashboard, or collaborative tool, SignalR provides the infrastructure you need. Let's dive into how to get started and best practices for production applications.",
                Author = "Jane Smith",
                CategoryName = "SignalR",
                PostCreatedAt = DateTime.Now.AddDays(-5),
                ReadingDuration = "12 min read",
                PostLike = 89,
                CommentCount = 8,
                PhotoIsliked = true,
                Tags = new List<TagDto>
                {
                    new TagDto { Name = "signalr" },
                    new TagDto { Name = "real-time" },
                    new TagDto { Name = "websockets" }
                }
            },
            new PostSummaryDto
            {
                Id = 3,
                Title = "Mastering Blazor Component Communication",
                Content = "Component communication is fundamental to building complex Blazor applications. Understanding the different patterns - parameters, cascading values, EventCallback, and state management - will help you build maintainable and scalable applications. This guide covers all the essential patterns with practical examples.",
                Author = "Mike Johnson",
                CategoryName = "Blazor",
                PostCreatedAt = DateTime.Now.AddDays(-7),
                ReadingDuration = "15 min read",
                PostLike = 201,
                CommentCount = 23,
                PhotoIsliked = false,
                Tags = new List<TagDto>
                {
                    new TagDto { Name = "blazor" },
                    new TagDto { Name = "components" },
                    new TagDto { Name = "state-management" }
                }
            },
            new PostSummaryDto
            {
                Id = 4,
                Title = "Entity Framework Core Performance Tips",
                Content = "Entity Framework Core is powerful, but it's easy to write queries that perform poorly. Learn the top 10 performance tips that every EF Core developer should know, from query optimization to proper use of tracking and AsNoTracking, to implementing efficient bulk operations.",
                Author = "Sarah Williams",
                CategoryName = "Entity Framework",
                PostCreatedAt = DateTime.Now.AddDays(-10),
                ReadingDuration = "10 min read",
                PostLike = 156,
                CommentCount = 12,
                PhotoIsliked = false,
                Tags = new List<TagDto>
                {
                    new TagDto { Name = "entity-framework" },
                    new TagDto { Name = "performance" },
                    new TagDto { Name = "database" },
                    new TagDto { Name = "optimization" }
                }
            },
            new PostSummaryDto
            {
                Id = 5,
                Title = "Dependency Injection Best Practices in .NET",
                Content = "Dependency Injection is a cornerstone of modern .NET development. This article explores best practices, common pitfalls to avoid, and how to structure your services for maximum testability and maintainability. We'll also cover advanced scenarios like scoped vs transient lifetimes.",
                Author = "David Brown",
                CategoryName = "Architecture",
                PostCreatedAt = DateTime.Now.AddDays(-14),
                ReadingDuration = "11 min read",
                PostLike = 178,
                CommentCount = 19,
                PhotoIsliked = true,
                Tags = new List<TagDto>
                {
                    new TagDto { Name = "dependency-injection" },
                    new TagDto { Name = "architecture" },
                    new TagDto { Name = "best-practices" }
                }
            },
            new PostSummaryDto
            {
                Id = 6,
                Title = "Understanding Async/Await in C#",
                Content = "Asynchronous programming is essential for building responsive applications. Learn how async/await works under the hood, common pitfalls to avoid, and best practices for writing efficient asynchronous code in C#.",
                Author = "Emily Davis",
                CategoryName = "C# Fundamentals",
                PostCreatedAt = DateTime.Now.AddDays(-16),
                ReadingDuration = "9 min read",
                PostLike = 142,
                CommentCount = 11,
                PhotoIsliked = false,
                Tags = new List<TagDto>
                {
                    new TagDto { Name = "async" },
                    new TagDto { Name = "csharp" },
                    new TagDto { Name = "concurrency" }
                }
            },
            new PostSummaryDto
            {
                Id = 7,
                Title = "Docker Containers for .NET Developers",
                Content = "Containerization has revolutionized how we deploy applications. This guide walks through creating Docker containers for .NET applications, from basic Dockerfiles to multi-stage builds and orchestration with Docker Compose.",
                Author = "Robert Taylor",
                CategoryName = "DevOps",
                PostCreatedAt = DateTime.Now.AddDays(-18),
                ReadingDuration = "14 min read",
                PostLike = 95,
                CommentCount = 7,
                PhotoIsliked = false,
                Tags = new List<TagDto>
                {
                    new TagDto { Name = "docker" },
                    new TagDto { Name = "containers" },
                    new TagDto { Name = "devops" }
                }
            },
            new PostSummaryDto
            {
                Id = 8,
                Title = "Building RESTful APIs with Minimal APIs",
                Content = "Minimal APIs in .NET provide a simplified approach to building HTTP APIs. Learn how to create fast, lightweight APIs with less ceremony while maintaining best practices for production applications.",
                Author = "Lisa Anderson",
                CategoryName = "Web APIs",
                PostCreatedAt = DateTime.Now.AddDays(-20),
                ReadingDuration = "10 min read",
                PostLike = 167,
                CommentCount = 14,
                PhotoIsliked = true,
                Tags = new List<TagDto>
                {
                    new TagDto { Name = "minimal-apis" },
                    new TagDto { Name = "rest" },
                    new TagDto { Name = "api" }
                }
            },
            new PostSummaryDto
            {
                Id = 9,
                Title = "Testing Strategies for Blazor Applications",
                Content = "Effective testing is crucial for maintaining quality in Blazor applications. Explore unit testing, integration testing, and end-to-end testing strategies specifically tailored for Blazor components and applications.",
                Author = "Chris Martinez",
                CategoryName = "Testing",
                PostCreatedAt = DateTime.Now.AddDays(-22),
                ReadingDuration = "13 min read",
                PostLike = 129,
                CommentCount = 16,
                PhotoIsliked = false,
                Tags = new List<TagDto>
                {
                    new TagDto { Name = "testing" },
                    new TagDto { Name = "blazor" },
                    new TagDto { Name = "quality-assurance" }
                }
            },
            new PostSummaryDto
            {
                Id = 10,
                Title = "Security Best Practices in ASP.NET Core",
                Content = "Security should never be an afterthought. Learn essential security practices for ASP.NET Core applications, including authentication, authorization, CORS, CSRF protection, and secure data handling.",
                Author = "Amanda White",
                CategoryName = "Security",
                PostCreatedAt = DateTime.Now.AddDays(-25),
                ReadingDuration = "16 min read",
                PostLike = 213,
                CommentCount = 28,
                PhotoIsliked = false,
                Tags = new List<TagDto>
                {
                    new TagDto { Name = "security" },
                    new TagDto { Name = "aspnetcore" },
                    new TagDto { Name = "authentication" }
                }
            },
            new PostSummaryDto
            {
                Id = 11,
                Title = "State Management Patterns in Blazor",
                Content = "Managing application state in Blazor can be challenging. Explore various state management patterns including cascading parameters, app state, local storage, and when to use each approach.",
                Author = "Kevin Lee",
                CategoryName = "Blazor",
                PostCreatedAt = DateTime.Now.AddDays(-28),
                ReadingDuration = "11 min read",
                PostLike = 186,
                CommentCount = 20,
                PhotoIsliked = true,
                Tags = new List<TagDto>
                {
                    new TagDto { Name = "blazor" },
                    new TagDto { Name = "state-management" },
                    new TagDto { Name = "architecture" }
                }
            },
            new PostSummaryDto
            {
                Id = 12,
                Title = "GraphQL vs REST: Choosing the Right API",
                Content = "Both GraphQL and REST have their place in modern application development. This comprehensive comparison helps you understand when to use each approach and how to implement them effectively in .NET.",
                Author = "Rachel Green",
                CategoryName = "Web APIs",
                PostCreatedAt = DateTime.Now.AddDays(-30),
                ReadingDuration = "12 min read",
                PostLike = 154,
                CommentCount = 18,
                PhotoIsliked = false,
                Tags = new List<TagDto>
                {
                    new TagDto { Name = "graphql" },
                    new TagDto { Name = "rest" },
                    new TagDto { Name = "api-design" }
                }
            }
        };
    }

    private async Task LoadMorePosts()
    {
        isLoadingMore = true;
        pageRequest.PageNumber++;
        await LoadPosts();
        isLoadingMore = false;
    }

    private void NavigateToPost(int postId)
    {
        Navigation.NavigateTo($"/viewblogconstruct/{postId}");
    }

    private string GetExcerpt(string content)
    {
        // Strip HTML tags and get first 200 characters
        var plainText = System.Text.RegularExpressions.Regex.Replace(content ?? "", "<.*?>", string.Empty);
        return plainText.Length > 200 ? plainText.Substring(0, 200) + "..." : plainText;
    }
}