@page "/create-post"
@attribute [Authorize(Roles = "Admin,Author")]

<div class="h-screen  overflow-auto bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        @if (isLoading)
        {
            <div class="flex items-center justify-center h-screen">
                <div class="text-center">
                    <div class="relative">
                        <div class="inline-block animate-spin rounded-full h-16 w-16 border-4 border-indigo-200 border-t-indigo-600"></div>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <svg class="w-8 h-8 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                        </div>
                    </div>
                    <p class="mt-6 text-lg font-medium text-gray-700">Loading editor...</p>
                    <p class="mt-2 text-sm text-gray-500">Preparing your workspace</p>
                </div>
            </div>
        }
        else
        {
        
            <div class="mb-8 bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-indigo-100/50 p-5">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="relative">
                            <div class="w-14 h-14 bg-gradient-to-br from-indigo-500 to-purple-500  rounded-2xl flex items-center justify-center shadow-xl">
                                <svg class="w-7 h-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </div>
                        </div>

                        <h1 class="text-2xl font-bold  text-gray-700">Create New Post</h1>

                        <p class="text-gray-600 mt-1">Share your insights and stories with the community</p>

                    </div>
                    <button @onclick="NavigateBack" class="group w-11 h-11 flex items-center justify-center rounded-xl hover:bg-gray-100 text-gray-400 hover:text-gray-900 transition-all duration-200 border border-gray-200 hover:border-gray-300 hover:shadow-md">
                        <svg class="w-5 h-5 transition-transform group-hover:scale-110" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>

            <EditForm Model="@Post" OnValidSubmit="HandlePublish" FormName="CreateBlog">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">


                    <div class="lg:col-span-2 space-y-6 ">


                        <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-indigo-100/50 p-6 hover:shadow-xl transition-all duration-300">
                            <div class="flex items-center gap-2 mb-4">
                                <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                                    </svg>
                                </div>
                                <label class="text-sm font-semibold text-gray-900">Post Title</label>
                                <span class="text-red-500 text-lg">*</span>
                            </div>
                            <InputText @bind-Value="Post.Title"
                                       placeholder="Write a compelling title that captures attention..."
                                       class="w-full px-4 py-3.5 text-lg border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200 placeholder:text-gray-400 bg-gray-50 hover:bg-white" />

                            @if (!string.IsNullOrEmpty(titleError))
                            {
                                <p class="text-sm text-red-600 font-medium">⚠️ @titleError</p>
                            }
                                   </div>


                        <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-indigo-100/50 p-6 hover:shadow-xl transition-all duration-300">
                            <div class="flex items-center gap-2 mb-4">
                                <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                </div>
                                <label class="text-sm font-semibold text-gray-900">Featured Image</label>
                            </div>

                            @if (string.IsNullOrEmpty(previewImageUrl))
                            {
                                <div class="group relative border-2 border-dashed border-indigo-200 rounded-2xl p-12 text-center hover:border-indigo-400 hover:bg-gradient-to-br hover:from-indigo-50/50 hover:to-purple-50/50 transition-all duration-300 cursor-pointer bg-gradient-to-br from-gray-50 to-indigo-50/30">
                                    <InputFile OnChange="HandleImageUpload" class="hidden" id="imageUpload" accept="image/*" />
                                    <label for="imageUpload" class="cursor-pointer block">
                                        <div class="w-20 h-20 mx-auto mb-4 bg-gradient-to-br from-indigo-100 to-purple-100 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300 shadow-lg">
                                            <svg class="w-10 h-10 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                        </div>
                                        <p class="text-gray-900 font-semibold mb-1">Click to upload or drag and drop</p>
                                        <p class="text-sm text-gray-500">PNG, JPG, GIF up to 10MB</p>
                                    </label>
                                </div>
                            }
                            else
                            {
                                <div class="relative group overflow-hidden rounded-2xl">
                                    <img src="@previewImageUrl" class="w-full h-80 object-cover transition-transform duration-300 group-hover:scale-105" alt="Featured" />
                                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center">
                                        <button type="button" @onclick="RemoveImage"
                                                class="bg-indigo-600 text-white px-5 py-3 rounded-xl hover:bg-indigo-700 transition-all flex items-center gap-2 shadow-2xl font-semibold transform hover:scale-105 border border-indigo-700">
                                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                            </svg>
                                            Remove Image
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>


                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition-shadow duration-200 flex flex-col flex-1 border-indigo-100 z-10">
                            <div class="flex items-center gap-2 mb-4">
                                <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                </div>
                                <label class="text-sm font-semibold text-gray-900">Content</label>
                                <span class="text-red-500 text-lg">*</span>
                            </div>
                            <div class="rounded-xl overflow-hidden shadow-sm flex-1 border border-indigo-100">
                                @if (isEditorLoading)
                                {
                                    <div class="w-full h-96 bg-gradient-to-br from-gray-50 to-indigo-50/30 animate-pulse p-6 space-y-4">
                                        <div class="h-10 bg-gray-200/70 rounded-lg"></div>
                                        <div class="h-8 bg-gray-200/70 rounded-lg w-3/4"></div>
                                        <div class="h-6 bg-gray-200/70 rounded-lg w-1/2"></div>
                                        <div class="space-y-3 pt-4">
                                            <div class="h-4 bg-gray-200/70 rounded"></div>
                                            <div class="h-4 bg-gray-200/70 rounded w-5/6"></div>
                                            <div class="h-4 bg-gray-200/70 rounded w-4/5"></div>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <div @ref="editorElement"></div>
                                  
                                }
                            </div>
            
                    </div>
                        <div class="rounded-xl overflow-hidden shadow-sm flex-1 border border-indigo-100">
                            @if (isEditorLoading)
                            {
                                <div class="w-full h-96 bg-gradient-to-br from-gray-50 to-indigo-50/30 animate-pulse p-6 space-y-4">
                                    <div class="h-10 bg-gray-200/70 rounded-lg"></div>
                                    <div class="h-8 bg-gray-200/70 rounded-lg w-3/4"></div>
                                    <div class="h-6 bg-gray-200/70 rounded-lg w-1/2"></div>
                                    <div class="space-y-3 pt-4">
                                        <div class="h-4 bg-gray-200/70 rounded"></div>
                                        <div class="h-4 bg-gray-200/70 rounded w-5/6"></div>
                                        <div class="h-4 bg-gray-200/70 rounded w-4/5"></div>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div @ref="editorElement"></div>
                                if (!string.IsNullOrEmpty(contentError))
                                {
                                    <p class="text-sm text-red-600 font-medium">⚠️ @contentError</p>


                                }
                            }
                        </div>



                    </div>


                    <div class="lg:col-span-1 space-y-6">


                        <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-indigo-100/50 p-6 hover:shadow-xl transition-all duration-300">
                            <div class="flex items-center gap-2 mb-5">
                                <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-indigo-500 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                                    </svg>
                                </div>
                                <h3 class="text-lg font-bold text-gray-900">Publish Settings</h3>
                            </div>

                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Status</label>
                                    <AuthorizeView Roles="Admin">
                                        <Authorized Context="authState">
                                            <InputSelect @bind-Value="Post.Status"
                                                         class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200 bg-gray-50 hover:bg-white font-medium">
                                                <option value="@EntityEnum.Status.Published"> Published</option>
                                                <option value="@EntityEnum.Status.Draft"> Draft</option>
                                            </InputSelect>
                                        </Authorized>
                                    </AuthorizeView>
                                    <AuthorizeView Roles="Author">
                                        <Authorized Context="authState">
                                            <InputSelect @bind-Value="Post.Status"
                                                         class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200 bg-gray-50 hover:bg-white font-medium">
                                                <option value="@EntityEnum.Status.Pending"> Pending</option>
                                                <option value="@EntityEnum.Status.Published" disabled> Published</option>
                                                <option value="@EntityEnum.Status.Draft" disabled> Draft</option>
                                            </InputSelect>
                                        </Authorized>
                                    </AuthorizeView>
                                </div>

                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Author</label>
                                    <InputText @bind-Value="Post.Author"
                                               placeholder="Your name"
                                               class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200 bg-gray-50 hover:bg-white" />
                                    @if (!string.IsNullOrEmpty(authorError))
                                    {
                                        <p class="text-sm text-red-600 font-medium">⚠️ @authorError</p>
                                     
                                   
                                    }
                                           </div>

                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Publish Date</label>
                                    <InputDate @bind-Value="PublishedDate"
                                               class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200 bg-gray-50 hover:bg-white" />
                                </div>

                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Reading Time</label>
                                    <InputSelect @bind-Value="Post.ReadingDuration"
                                                 class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200 bg-gray-50 hover:bg-white font-medium">
                                        <option value="@ReadingDuration.Minutes5">⏱️ 5 Minutes</option>
                                        <option value="@ReadingDuration.Minutes10">⏱️ 10 Minutes</option>
                                        <option value="@ReadingDuration.Minutes15">⏱️ 15 Minutes</option>
                                        <option value="@ReadingDuration.Minutes20">⏱️ 20 Minutes</option>
                                        <option value="@ReadingDuration.Minutes25">⏱️ 25 Minutes</option>
                                        <option value="@ReadingDuration.Minutes30">⏱️ 30 Minutes</option>
                                        <option value="@ReadingDuration.Minutes35">⏱️ 35 Minutes</option>
                                        <option value="@ReadingDuration.Minutes40">⏱️ 40 Minutes</option>
                                        <option value="@ReadingDuration.Minutes45">⏱️ 45 Minutes</option>
                                        <option value="@ReadingDuration.Minutes50">⏱️ 50 Minutes</option>
                                        <option value="@ReadingDuration.Minutes55">⏱️ 55 Minutes</option>
                                        <option value="@ReadingDuration.OneHour">⏱️ 1 Hour</option>
                                        <option value="@ReadingDuration.OneHourPlus">⏱️ 1 Hour +</option>
                                    </InputSelect>
                                </div>
                            </div>
                        </div>


                        <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-indigo-100/50 p-6 hover:shadow-xl transition-all duration-300">
                            <div class="flex items-center gap-2 mb-5">
                                <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                                    </svg>
                                </div>
                                <h3 class="text-lg font-bold text-gray-900">Category</h3>
                            </div>

                            @if (selectedCategoryId.HasValue)
                            {
                                <div class="mb-4 p-3 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl border-2 border-indigo-200">
                                    <div class="flex items-center justify-between">
                                        <span class="inline-flex items-center gap-2 text-indigo-900 font-semibold">
                                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                                            </svg>
                                            @GetCategoryNameById(selectedCategoryId.Value)
                                        </span>
                                        <button type="button" @onclick="ClearCategory" class="text-indigo-600 hover:text-indigo-900 hover:bg-indigo-200 rounded-lg p-1.5 transition-colors">
                                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            }

                            <input type="text"
                                   @bind="CategorySearchQuery"
                                   @bind:event="oninput"
                                   @onkeyup="HandlingCategoryQuery"
                                   class="w-full px-4 py-3 mb-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200 bg-gray-50 hover:bg-white"
                                   placeholder="🔍 Search categories..." />

                            <div class="max-h-64 overflow-y-auto space-y-2 mb-4">
                                @if (!showNewCategory)
                                {
                                    @if (FilteredCategory?.IsSuccess == true && FilteredCategory.Value != null)
                                    {
                                        @foreach (var category in FilteredCategory.Value.Where(c => c.Id != selectedCategoryId))
                                        {
                                            <button type="button" @onclick="() => SelectCategory(category.Id)"
                                                    class="w-full px-4 py-3 text-left bg-gradient-to-r from-gray-50 to-indigo-50/50 hover:from-indigo-50 hover:to-purple-50 rounded-xl transition-all font-medium border-2 border-transparent hover:border-indigo-200 flex items-center gap-2 group">
                                                <svg class="w-4 h-4 text-indigo-600 opacity-0 group-hover:opacity-100 transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                                                </svg>
                                                <span class="text-gray-700 group-hover:text-indigo-900">@category.Name</span>
                                            </button>
                                        }
                                    }
                                }
                            </div>

                            @if (!showNewCategory)
                            {
                                <button type="button" @onclick="() => showNewCategory = true"
                                        class="w-full px-4 py-3 text-indigo-600 hover:text-indigo-700 font-semibold hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 rounded-xl transition-all border-2 border-indigo-200 hover:border-indigo-300 flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                    </svg>
                                    Create New Category
                                </button>
                            }
                            else
                            {
                                <div class="space-y-3 p-4 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl border-2 border-indigo-200">
                                    <InputText @bind-Value="newCategory"
                                               placeholder="Enter category name"
                                               class="w-full px-4 py-3 border-2 border-indigo-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200 bg-white" />
                                    @if (!string.IsNullOrEmpty(categoryError))
                                    {
                                        <p class="text-sm text-red-600 font-medium">⚠️ @categoryError</p>
                                    }
                                    <div class="flex gap-2">
                                        <button type="button" @onclick="HandleCategory"
                                                class="flex-1 px-4 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl font-semibold hover:from-indigo-700 hover:to-purple-700 transition-all shadow-md hover:shadow-lg">
                                            Add
                                        </button>
                                        <button type="button" @onclick="() => { showNewCategory = false; newCategory = string.Empty; categoryError = string.Empty; }"
                                                class="flex-1 px-4 py-3 bg-white text-gray-700 rounded-xl font-semibold hover:bg-gray-100 transition-all border-2 border-gray-200">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>


                        <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-indigo-100/50 p-6 hover:shadow-xl transition-all duration-300">
                            <div class="flex items-center gap-2 mb-5">
                                <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                                    </svg>
                                </div>
                                <h3 class="text-lg font-bold text-gray-900">Tags</h3>
                            </div>

                            @if (selectedTags.Any())
                            {
                                <div class="flex flex-wrap gap-2 mb-4 p-3 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl border-2 border-indigo-200">
                                    @foreach (var tagId in selectedTags)
                                    {
                                        var tagName = GetTagNameById(tagId);
                                        <span class="inline-flex items-center gap-2 bg-white border-2 border-indigo-200 text-indigo-700 px-3 py-2 rounded-xl font-semibold shadow-sm hover:shadow-md transition-all hover:border-indigo-300">
                                            <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                                            </svg>
                                            @tagName
                                            <button type="button" @onclick="() => RemoveTag(tagId)" class="hover:text-indigo-900 hover:bg-indigo-100 rounded-full p-1 transition-colors">
                                                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                                </svg>
                                            </button>
                                        </span>
                                    }
                                </div>
                            }

                            <input type="text"
                                   @bind="SearchQuery"
                                   @bind:event="oninput"
                                   @onkeyup="HandlingQuery"
                                   class="w-full px-4 py-3 mb-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200 bg-gray-50 hover:bg-white"
                                   placeholder="🔍 Search tags..." />

                            <div class="max-h-64 overflow-y-auto space-y-2 mb-4">
                                @if (!showNewTag)
                                {
                                    @if (FilteredTag?.IsSuccess == true && FilteredTag.Value != null)
                                    {
                                        @foreach (var tag in FilteredTag.Value.Where(t => !selectedTags.Contains(t.Id)))
                                        {
                                            <button type="button" @onclick="() => AddExistingTag(tag.Id)"
                                                    class="w-full px-4 py-3 text-left bg-gradient-to-r from-gray-50 to-indigo-50/50 hover:from-indigo-50 hover:to-purple-50 rounded-xl transition-all font-medium border-2 border-transparent hover:border-indigo-200 flex items-center gap-2 group">
                                                <svg class="w-4 h-4 text-indigo-600 opacity-0 group-hover:opacity-100 transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                                </svg>
                                                <span class="text-gray-700 group-hover:text-indigo-900">@tag.Name</span>
                                            </button>
                                        }
                                    }
                                }
                            </div>

                            @if (!showNewTag)
                            {
                                <button type="button" @onclick="() => showNewTag = true"
                                        class="w-full px-4 py-3 text-indigo-600 hover:text-indigo-700 font-semibold hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 rounded-xl transition-all border-2 border-indigo-200 hover:border-indigo-300 flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                    </svg>
                                    Create New Tag
                                </button>
                            }
                            else
                            {
                                <div class="space-y-3 p-4 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl border-2 border-indigo-200">
                                    <InputText @bind-Value="newTag"
                                               placeholder="Enter tag name"
                                               class="w-full px-4 py-3 border-2 border-indigo-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200 bg-white" />

                                    @if (!string.IsNullOrEmpty(tagError))
                                    {
                                        <p class="text-sm text-red-600 font-medium">⚠️ @tagError</p>
                                    }

                                    <div class="flex gap-2">
                                        <button type="button" @onclick="AddNewTag"
                                                class="flex-1 px-4 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl font-semibold hover:from-indigo-700 hover:to-purple-700 transition-all shadow-md hover:shadow-lg">
                                            Add
                                        </button>
                                        <button type="button" @onclick="() => { showNewTag = false; newTag = string.Empty; tagError = string.Empty; }"
                                                class="flex-1 px-4 py-3 bg-white text-gray-700 rounded-xl font-semibold hover:bg-gray-100 transition-all border-2 border-gray-200">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>


                        <div class="space-y-3 sticky top-4">
                            <button type="submit" disabled="@isSaving"
                                    class="w-full px-6 py-4 bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 text-white rounded-xl font-bold hover:from-indigo-700 hover:via-purple-700 hover:to-pink-700 transition-all duration-300 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed shadow-xl hover:shadow-2xl transform hover:-translate-y-1">
                                @if (isSaving)
                                {
                                    <div class="inline-block animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent"></div>
                                    <span>Publishing...</span>
                                }
                                else
                                {
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                    </svg>
                                    <AuthorizeView Roles="Admin">
                                        <Authorized Context="authState">
                                            <span>Publish Post</span>
                                        </Authorized>
                                    </AuthorizeView>
                                    <AuthorizeView Roles="Author">
                                        <Authorized Context="authState">
                                            <span>Submit Post</span>
                                        </Authorized>
                                    </AuthorizeView>
                                }
                            </button>

                            <button type="button" @onclick="SaveDraft" disabled="@isSaving"
                                    class="w-full px-6 py-4 bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 rounded-xl font-bold hover:from-gray-200 hover:to-gray-300 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed shadow-md hover:shadow-lg">
                                <div class="flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                                    </svg>
                                    Save as Draft
                                </div>
                            </button>

                            <label for="preview_post"
                                   class="w-full px-6 py-4 border-2 border-indigo-200 text-gray-700 rounded-xl font-bold hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 hover:border-indigo-300 transition-all duration-300 flex items-center justify-center gap-2 shadow-md hover:shadow-lg cursor-pointer">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                                Preview Post
                            </label>
                        </div>
                    </div>
                </div>
            </EditForm>
        }
    </div>
</div>

<PreviewPost Post="Post" Name="Name" FilteredTag="FilteredTag" previewImageUrl="@previewImageUrl" selectedTags="selectedTags" />


@code {
    private Result<List<TagDto>>? ListTag { get; set; }
    private Result<List<CategoryDto>>? ListCategory { get; set; }
    private Result<List<TagDto>>? FilteredTag { get; set; }
    private Result<List<CategoryDto>>? FilteredCategory { get; set; }
    private List<int> selectedTags = new List<int>();
    private int? selectedCategoryId = null;

    private CreatePostRequest Post { get; set; } = new CreatePostRequest
    {
        ReadingDuration = ReadingDuration.Minutes5,
        CategoryId = null
    };
    private AddCategoryRequest AddCat { get; set; } = new AddCategoryRequest();
    private AddTagRequest AddTag { get; set; } = new AddTagRequest();
    private UserProfileDto? Name { get; set; }

    private bool isLoading = true;
    private bool isSaving = false;
    private bool showNewCategory = false;
    private bool showNewTag = false;
    private bool isEditorLoading = false;

    private string newCategory = string.Empty;
    private string newTag = string.Empty;
    private string SearchQuery = "";
    private string CategorySearchQuery = "";
    private string previewImageUrl = string.Empty;
    private string tagError = string.Empty;
    private string categoryError = string.Empty;
    private string? titleError = string.Empty;
    private string? contentError = string.Empty;
    private string? authorError = string.Empty;

    public DateTime PublishedDate { get; set; }
    private ElementReference editorElement;
    private IJSObjectReference? quillInstance;

    protected override async Task OnInitializedAsync()
    {
        await AuthState();
        await LoadDataAsync();
        await LoadUserName();
    }


    private bool editorInitialized = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!isEditorLoading && !editorInitialized)
        {
            editorInitialized = true;

            await Task.Delay(100);

            try
            {
                Console.WriteLine("Attempting to initialize Quill editor...");

                var toolbar = QuillConfig.GetToolbarConfig();
                quillInstance = await JS.InvokeAsync<IJSObjectReference>(
                    "initQuill",
                    editorElement,
                    Post.Content ?? "",
                    toolbar
                );

                if (quillInstance != null)
                {
                    Console.WriteLine("Quill instance created successfully");

                    // Inject custom styles
                    var styles = QuillConfig.GetContentStyle();
                    await JS.InvokeVoidAsync("injectQuillStyles", styles);

                    // Keep showing skeleton until editor is fully rendered
                    await Task.Delay(200);
                    StateHasChanged();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing Quill: {ex.Message}");
                editorInitialized = false;
            }
        }
    }












    private async Task<string> GetEditorContent()
    {
        if (quillInstance != null)
        {
            return await JS.InvokeAsync<string>("getQuillContent", quillInstance);
        }
        return string.Empty;
    }

    public async Task AuthState()
    {
        var authstate = await AuthProvider.GetAuthenticationStateAsync();
        var user = authstate.User;

        Post.Status = user switch
        {
            var u when u.IsInRole("Admin") => Status.Published,
            var u when u.IsInRole("Author") => Status.Pending,
            _ => Status.Pending
        };
    }

    private async Task LoadUserName()
    {
        var request = await UserClient.GetCurrentUser();
        Name = request.Value;
        Post.Author = Name?.Name;
    }

    private async Task LoadDataAsync()
    {
        isLoading = true;
        isEditorLoading = true;
        StateHasChanged();

        PublishedDate = DateTime.UtcNow.AddHours(8);
        await Task.Delay(200);

        ListCategory = await CategoryClient.GetListing();
        ListTag = await TagClient.GetListing();
        FilteredTag = ListTag;
        FilteredCategory = ListCategory;

        isLoading = false;
        StateHasChanged();


        await Task.Delay(300);

        isEditorLoading = false;
        StateHasChanged();
    }





    private void SelectCategory(int categoryId)
    {
        selectedCategoryId = categoryId;
        Post.CategoryId = categoryId;
        CategorySearchQuery = string.Empty;
        FilteredCategory = ListCategory;
    }

    private void ClearCategory()
    {
        selectedCategoryId = null;
        Post.CategoryId = null;
    }

    private string GetCategoryNameById(int categoryId)
    {
        if (ListCategory?.IsSuccess == true && ListCategory.Value != null)
        {
            var category = ListCategory.Value.FirstOrDefault(c => c.Id == categoryId);
            return category?.Name ?? string.Empty;
        }
        return string.Empty;
    }

    private async Task HandleCategory()
    {
        if (string.IsNullOrWhiteSpace(newCategory)) return;

        categoryError = string.Empty;
        AddCat.Name = newCategory;
        var result = await CategoryClient.Create(AddCat);

        if (result?.IsSuccess == true && result.Value > 0)
        {
            ListCategory = await CategoryClient.GetListing();
            FilteredCategory = ListCategory;
            SelectCategory(result.Value);
            showNewCategory = false;
            newCategory = string.Empty;
        }
        else
        {
            categoryError = result?.Error ?? "Failed to create category";
        }
    }

    private async Task HandleImageUpload(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null && file.Size <= 10485760)
        {
            using var stream = file.OpenReadStream(maxAllowedSize: 10485760);
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);

            Post.Photo = memoryStream.ToArray();
            Post.PhotoContent = file.ContentType;

            var base64 = Convert.ToBase64String(Post.Photo);
            previewImageUrl = $"data:{file.ContentType};base64,{base64}";
        }
        StateHasChanged();
    }

    private void RemoveImage()
    {
        Post.Photo = null;
        Post.PhotoContent = null;
        previewImageUrl = string.Empty;
    }

    private void AddExistingTag(int tagId)
    {
        if (!selectedTags.Contains(tagId))
        {
            selectedTags.Add(tagId);
        }
    }

    private async Task AddNewTag()
    {
        if (string.IsNullOrWhiteSpace(newTag)) return;

        tagError = string.Empty;
        AddTag.Name = newTag;
        var result = await TagClient.Create(AddTag);

        if (result?.IsSuccess == true && result.Value > 0)
        {
            ListTag = await TagClient.GetListing();
            FilteredTag = ListTag;
            selectedTags.Add(result.Value);
            showNewTag = false;
            newTag = string.Empty;
        }
        else
        {
            tagError = result?.Error ?? "Failed to create tag";
        }
    }

    private void RemoveTag(int tagId)
    {
        selectedTags.Remove(tagId);
    }

    private string GetTagNameById(int tagId)
    {
        if (ListTag?.IsSuccess == true && ListTag.Value != null)
        {
            var tag = ListTag.Value.FirstOrDefault(t => t.Id == tagId);
            return tag?.Name ?? string.Empty;
        }
        return string.Empty;
    }

    private async Task HandlePublish()
    {
        isSaving = true;
        Post.Content = await GetEditorContent(); // Get content from Quill
        Post.Status = EntityEnum.Status.Published;
        Post.TagIds = selectedTags;
        titleError = string.Empty;
        contentError = string.Empty;
        authorError = string.Empty;

        var result = await PostClient.Create(Post);

        if (result?.IsSuccess == true)
        {
            Navigation.NavigateTo("/");
        }
        else if (result?.ValidationErrors != null && result.ValidationErrors.Any())
        {
            if (result.ValidationErrors.TryGetValue("Title",out var TitleErr))
            
                titleError = TitleErr.FirstOrDefault();
            
            if (result.ValidationErrors.TryGetValue("Content",out var contentErr))           
                contentError = contentErr.FirstOrDefault();

            if (result.ValidationErrors.TryGetValue("Author", out var authorErr))
                authorError = authorErr.FirstOrDefault();
        }   
        
        
        isSaving = false;
    }

     public async ValueTask DisposeAsync()
    {
        if (quillInstance != null)
        {
            await quillInstance.DisposeAsync();
        }
    }
    private async Task SaveDraft()
    {
        isSaving = true;
        Post.Content = await GetEditorContent(); // Get content from Quill
        Post.Status = EntityEnum.Status.Draft;
        Post.TagIds = selectedTags;

        var result = await PostClient.Create(Post);

        if (result?.IsSuccess == true)
        {
            Navigation.NavigateTo("/");
        }

        isSaving = false;
    }

    private void Preview()
    {
        Navigation.NavigateTo($"/preview");
    }

    private void NavigateBack()
    {
        Navigation.NavigateTo("/");
    }

    private void HandlingQuery()
    {
        var query = SearchQuery.ToLower();
        if (!string.IsNullOrEmpty(query))
        {
            FilteredTag = Result<List<TagDto>>.Success(ListTag!.Value!.Where(s => s.Name!.ToLower().Contains(query)).ToList());
        }
        else
        {
            FilteredTag = ListTag;
        }
    }

    private void HandlingCategoryQuery()
    {
        var query = CategorySearchQuery.ToLower();
        if (!string.IsNullOrEmpty(query))
        {
            FilteredCategory = Result<List<CategoryDto>>.Success(ListCategory!.Value!.Where(s => s.Name!.ToLower().Contains(query)).ToList());
        }
        else
        {
            FilteredCategory = ListCategory;
        }
    }
}