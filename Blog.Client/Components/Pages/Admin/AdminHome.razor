@page "/admin_home"


@using Microsoft.AspNetCore.SignalR.Client

<main class="p-6 lg:p-8 max-w-7xl w-full overflow-auto h-screen ">

    <header class="flex flex-col lg:flex-row justify-between items-start gap-4 mb-6 pb-4 border-b border-gray-200">
        <div>
            <h1 class="text-2xl lg:text-3xl font-semibold text-gray-800 mb-2">Developer Learning Journal</h1>
            <p class="text-base text-gray-600">Sharing my journey through .NET, Blazor, and Modern Web Development</p>
        </div>
        <div class="flex gap-3 items-center">
            @if (!hasrender)
            {
                <div class="skeleton w-10 h-10 rounded-full flex-shrink-0"></div>
            }
            else
            {
                <NavLink href="profile" class="flex-shrink-0 cursor-pointer border-2 rounded-full border-gray-300 hover:border-indigo-500 w-10 h-10 overflow-hidden transition-all">
                    @if (userProfile?.PhotoUrl is null)
                    {
                        <img src="/img/icon-proff.png" class="w-full h-full object-contain" />
                    }
                    else
                    {
                        <img src="@userProfile.PhotoUrl" class="w-full h-full object-cover" />
                    }
                </NavLink>
            }

            <NavLink href="bookmark" class="btn btn-ghost btn-square bg-indigo-50 hover:bg-indigo-50">
                <svg class="w-6 h-6 text-indigo-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.4" d="m17 21-5-4-5 4V3.889a.92.92 0 0 1 .244-.629.808.808 0 0 1 .59-.26h8.333a.81.81 0 0 1 .589.26.92.92 0 0 1 .244.63V21Z" />
                </svg>
            </NavLink>

            <div class="indicator">
                <span class="indicator-item badge bg-indigo-500 text-white">2</span>
                <button class="px-4 py-2 rounded-lg border border-gray-300 bg-white text-gray-700 font-medium text-sm hover:bg-gray-50 transition-all">
                    Approval
                </button>
            </div>

            <button @onclick="() => PageState.AdminView(PageState.AdminPostState.home)" class="btn btn-ghost btn-square bg-indigo-50 hover:bg-indigo-50">
                <svg class="w-6 h-6  text-indigo-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.4" d="m4 12 8-8 8 8M6 10.5V19a1 1 0 0 0 1 1h3v-3a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3h3a1 1 0 0 0 1-1v-8.5" />
                </svg>
            </button>
        </div>
    </header>

    <div class="flex flex-col lg:flex-row gap-2 mb-6 justify-between">

        <div class="flex flex-row items-center gap-3 ">
            <div class="flex gap-2 flex-row">
                <button @onclick="() => PageState.AdminView(PageState.AdminPostState.all_post)" class=" cursor-pointer px-4 py-2 rounded-lg border border-gray-300 bg-white text-gray-700 font-medium text-sm hover:bg-gray-50 transition-all">
                    All Posts
                </button>
                <button @onclick="() => PageState.AdminView(PageState.AdminPostState.published)" class="  cursor-pointer px-4 py-2 rounded-lg border border-gray-300 bg-white text-gray-700 font-medium text-sm hover:bg-gray-50 transition-all">
                    Published
                </button>
                <button @onclick="() => PageState.AdminView(PageState.AdminPostState.draft)" class=" cursor-pointer px-4 py-2 rounded-lg border border-gray-300 bg-white text-gray-700 font-medium text-sm hover:bg-gray-50 transition-all">
                    Draft
                </button>
                <div class="dropdown dropdown-bottom">
                    <button tabindex="0" class="btn btn-outline gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                        Author
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-52 p-2 shadow-lg border border-gray-200">
                        <li><button @onclick="() => PageState.AdminView(PageState.AdminPostState.author)" class="btn">All Authors</button></li>
                        <li><a>John Doe</a></li>
                        <li><a>Jane Smith</a></li>
                    </ul>
                </div>
                <button @onclick="() => PageState.AdminView(PageState.AdminPostState.overview)" class=" cursor-pointer btn btn-outline gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    Overview
                </button>
            </div>
        </div>

        <div class="flex gap-2 min-w-0 flex-shrink">
            <label class="input input-bordered flex items-center gap-2 w-[100%]">
                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input type="text" class="w-[100%]" placeholder="Search posts..." />
            </label>
            <NavLink href="admin/create-blog" class=" cursor-pointer btn text-white bg-indigo-500 gap-2 whitespace-nowrap">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                New Post
            </NavLink>
        </div>
    </div>

    @if (PageState.AdminPageView == PageState.AdminPostState.home)
    {
        <Featured featuredPosts="featuredPosts" ReadMore="HandleReadMore" />
        <RecentPosts recentPost="recentPost" />
    }
    else if (PageState.AdminPageView == PageState.AdminPostState.all_post)
    {
        <AllPosts recentPost="recentPost" Pagination="Pagination" Refresh="RefreshAsync" />
    }
    else if (PageState.AdminPageView == PageState.AdminPostState.published)
    {
        <AdminPublished ListForAdmin="ListForAdmin" Pagination="PaginationPublished" Refresh="RefreshPublishedAsync" />
    }
    else if (PageState.AdminPageView == PageState.AdminPostState.draft)
    {
        <AdminDraft ListDraftForAdmin="ListDraftForAdmin" Pagination="PaginationDraft" Refresh="RefreshDraftAsync" />
    }
    else if (PageState.AdminPageView == PageState.AdminPostState.author)
    {
        <AdminAuthor />
    }
    else if (PageState.AdminPageView == PageState.AdminPostState.overview)
    {
        <AdminOverview />
    }
</main>

<style>
    .hide-scrollbar::-webkit-scrollbar {
        display: none;
    }

    .hide-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
</style>

@code {
    public bool hasrender = false;
    private UserProfileDto? userProfile { get; set; } = new UserProfileDto();
    private List<FeaturedPostDto>? featuredPosts { get; set; } = new List<FeaturedPostDto>();
    private PagedResult<PostDto>? recentPost { get; set; } = new PagedResult<PostDto>();
    private PagedResult<PostDto>? ListForAdmin { get; set; } = new PagedResult<PostDto>();
    private PagedResult<PostDto>? ListDraftForAdmin { get; set; } = new PagedResult<PostDto>();

    private ListPaginatedRequest Pagination { get; set; } = new ListPaginatedRequest { PageNumber = 1, PageSize = 10 };
    private ListPaginatedRequest PaginationPublished { get; set; } = new ListPaginatedRequest { PageNumber = 1, PageSize = 10 };
    private ListPaginatedRequest PaginationDraft { get; set; } = new ListPaginatedRequest { PageNumber = 1, PageSize = 10 };

    private HubConnection? _hubConnection;

    protected override async Task OnInitializedAsync()
    {
        await GetCurrentUser();
        await ListFeatured();
        await LoadPublishedPostsAsync();
        await LoadAdminPublishedPostsAsync();
        await LoadAdminDraftPostsAsync();

        await SignalR.InitializeAsync();
        SignalR.OnViewCountUpdate((postId, viewCount) =>
       {
           var post = featuredPosts?.FirstOrDefault(p => p.PostId == postId);
           if (post != null)
           {
               post.ViewCount = viewCount;
               InvokeAsync(StateHasChanged);
           }
       });

        hasrender = true;
    }

    public async ValueTask DisposeAsync()
    {
        await SignalR.DisposeAsync();
    }



    public async Task RefreshAsync() => await LoadPublishedPostsAsync();
    public async Task RefreshPublishedAsync() => await LoadAdminPublishedPostsAsync();
    public async Task RefreshDraftAsync() => await LoadAdminDraftPostsAsync();

    private async Task ListFeatured()
    {
        var featured = await PostClient.ListFeatured();
        featuredPosts = featured.Value ?? new List<FeaturedPostDto>();
    }

    private async Task GetCurrentUser()
    {
        var request = await ClientService.GetCurrentUser();
        userProfile = request.Value;
    }

    private async Task LoadPublishedPostsAsync()
    {
        var recent = await PostClient.ListPublished(Pagination);
        recentPost = recent.Value;
        StateHasChanged();
    }

    private async Task LoadAdminPublishedPostsAsync()
    {
        var listForAdmin = await PostClient.ListPublishedForAdmin(PaginationPublished);
        ListForAdmin = listForAdmin.Value;
        StateHasChanged();
    }

    private async Task LoadAdminDraftPostsAsync()
    {
        var listDraftForAdmin = await PostClient.ListDraftForAdmin(PaginationDraft);
        ListDraftForAdmin = listDraftForAdmin.Value;
        StateHasChanged();
    }

    public async Task HandleReadMore(int? Id)
    {
        await PostClient.TrackPostView(Id);
        Navigation.NavigateTo($"viewblogconstruct/{Id}");
        StateHasChanged();
    }
}
