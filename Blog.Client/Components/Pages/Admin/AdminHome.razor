@page "/admin_home"
@attribute [Authorize(Roles = "Admin")]


<main class="p-6 lg:p-8 max-w-7xl w-full overflow-auto h-screen ">

    <header class="flex flex-col lg:flex-row justify-between items-start gap-4 mb-6 pb-4 border-b border-gray-200">
        <div>
            <h1 class="text-2xl lg:text-3xl font-semibold text-gray-800 mb-2">Developer Learning Journal</h1>
            <p class="text-base text-gray-600">Sharing my journey through .NET, Blazor, and Modern Web Development</p>
        </div>
        <div class="flex gap-3 items-center">
            @if (!hasrender)
            {
                <div class="skeleton w-10 h-10 rounded-full flex-shrink-0"></div>
            }
            else
            {

                <NavLink href="profile" class="flex-shrink-0 cursor-pointer border-2 rounded-full border-gray-300 hover:border-indigo-500 w-10 h-10 overflow-hidden transition-all">
                    @if (userProfile?.PhotoUrl is null)
                    {
                        <img src="/img/icon-proff.png" class="w-full h-full object-contain" />
                    }
                    else
                    {
                        <img src="@userProfile.PhotoUrl" class="w-full h-full object-cover" />
                    }
                </NavLink>
            }
            <div class="indicator">
                @if (TotalCount?.PendingCount > 0)
                {
                    <span class="indicator-item badge bg-indigo-500 text-white">@TotalCount.PendingCount</span>
                }
                <NavLink href="approval" class=" cursor-pointer px-4 py-2 rounded-lg border border-gray-300 bg-white text-gray-700 font-medium text-sm hover:bg-gray-50 transition-all">
                    Approval
                </NavLink>
            </div>
            <NavLink href="bookmark" class="">
                <svg class="w-7 h-7  text-indigo-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M7.833 2c-.507 0-.98.216-1.318.576A1.92 1.92 0 0 0 6 3.89V21a1 1 0 0 0 1.625.78L12 18.28l4.375 3.5A1 1 0 0 0 18 21V3.889c0-.481-.178-.954-.515-1.313A1.808 1.808 0 0 0 16.167 2H7.833Z" />
                </svg>

            </NavLink>
            <div class="indicator">
                @if (TotalCount?.NotificationCount > 0)
                {
                    <span class="indicator-item badge bg-indigo-500 text-white">@TotalCount.NotificationCount</span>
                }
                <NavLink href="notification" class="">
                    <svg class="w-7 h-7 text-indigo-500 " aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="0.6" d="M12 5.365V3m0 2.365a5.338 5.338 0 0 1 5.133 5.368v1.8c0 2.386 1.867 2.982 1.867 4.175 0 .593 0 1.292-.538 1.292H5.538C5 18 5 17.301 5 16.708c0-1.193 1.867-1.789 1.867-4.175v-1.8A5.338 5.338 0 0 1 12 5.365ZM8.733 18c.094.852.306 1.54.944 2.112a3.48 3.48 0 0 0 4.646 0c.638-.572 1.236-1.26 1.33-2.112h-6.92Z" />
                    </svg>
                </NavLink>

            </div>




            <button @onclick="() => PostViewState.AdminView(PostViewState.AdminPostState.home)" class="cursor-pointer">
                <svg class="w-7 h-7  text-indigo-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="0.7" d="m4 12 8-8 8 8M6 10.5V19a1 1 0 0 0 1 1h3v-3a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3h3a1 1 0 0 0 1-1v-8.5" />
                </svg>

            </button>

        </div>
    </header>

    <div class="flex flex-col lg:flex-row gap-2 mb-6 justify-between">

        <div class="flex flex-row items-center gap-3 ">
            <div class="flex gap-2 flex-row">
                <button @onclick="() => PostViewState.AdminView(PostViewState.AdminPostState.all_post)" class=" cursor-pointer px-4 py-2 rounded-lg border border-gray-300 bg-white text-gray-700 font-medium text-sm hover:bg-gray-50 transition-all">
                    All Posts
                </button>
                <button @onclick="() => PostViewState.AdminView(PostViewState.AdminPostState.published)" class="  cursor-pointer px-4 py-2 rounded-lg border border-gray-300 bg-white text-gray-700 font-medium text-sm hover:bg-gray-50 transition-all">
                    Published
                </button>
                <button @onclick="() => PostViewState.AdminView(PostViewState.AdminPostState.draft)" class=" cursor-pointer px-4 py-2 rounded-lg border border-gray-300 bg-white text-gray-700 font-medium text-sm hover:bg-gray-50 transition-all">
                    Draft
                </button>






                <div class="dropdown dropdown-bottom">
                    <button tabindex="0" class="btn btn-outline gap-2 hover:bg-base-200 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                        Author
                        <svg class="w-3 h-3 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>

                    <ul class="dropdown-content menu bg-base-100 rounded-lg z-[1] w-64 p-0 shadow-xl border border-base-300 mt-2">
                  
                        <li class="menu-title px-4 pt-3 pb-2">
                            <div class="flex items-center justify-between">
                                <span class="text-xs font-semibold uppercase tracking-wider opacity-60">Top 5 Author</span>
                                <span class="badge badge-sm badge-ghost">5</span>
                            </div>
                        </li>

                        <li class="px-2">
                            <a @onpointerdown="HandleAllAuthorsClickAsync"
                               @onpointerdown:preventDefault="true"
                               class="justify-start gap-2 font-medium hover:bg-primary hover:text-primary-content rounded-md transition-all cursor-pointer">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                                All Authors
                            </a>
                        </li>


                        <li><div class="divider my-1"></div></li>

               
                        @if (ListAuthors != null)
                        {
                            @foreach (var author in ListAuthors)
                            {
                                <li class="px-2">
                                    <NavLink href="@($"view/{author.UserId}")" class="flex items-center gap-3 py-2.5 rounded-md hover:bg-base-200 transition-colors group">
                                  
                                        <div class="avatar placeholder">
                                            <div class="bg-neutral text-neutral-content rounded-full w-8 h-8">
                                                @if (!string.IsNullOrEmpty(author.ProfilePhoto))
                                                {
                                                    <img src="@author.ProfilePhoto" class="w-full h-full bg-contain" />
                                                }else
                                                {
                                                     <img src="/img/icon-proff.png" class="w-full h-full bg-contain"  />
                                                }
                                            </div>
                                        </div>

                                   
                                        <span class="flex-1 text-sm font-medium group-hover:text-primary transition-colors">
                                            @author.Name
                                        </span>

                                    
                                        <span class="badge badge-ghost badge-sm opacity-60 group-hover:opacity-100">
                                          @author.PostCount
                                        </span>
                                    </NavLink>
                                </li>
                            }
                        }
                        else
                        {
                            <li class="px-4 py-6 text-center text-sm opacity-60">
                                No authors found
                            </li>
                        }
                    </ul>
                </div>





                <button @onclick="() => PostViewState.AdminView(PostViewState.AdminPostState.overview)" class=" cursor-pointer btn btn-outline gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    Overview
                </button>
            </div>
        </div>

        <div class="flex gap-2 min-w-0 flex-shrink">
            <label class="input input-bordered flex items-center gap-2 w-[100%]">
                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input type="text" class="w-[100%]" placeholder="Search posts..." />
            </label>
            <NavLink href="create-post" class=" cursor-pointer btn text-white bg-indigo-500 gap-2 whitespace-nowrap">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                New Post
            </NavLink>
        </div>
    </div>

    @if (PostViewState.AdminPageView == PostViewState.AdminPostState.home)
    {
        <Featured featuredPosts="featuredPosts" ReadMore="HandleReadMore" />
        <RecentPosts recentPost="recentPost" />
    }
    else if (PostViewState.AdminPageView == PostViewState.AdminPostState.all_post)
    {
        <AllPosts recentPost="recentPost" Pagination="Pagination" Refresh="RefreshAsync" />
    }
    else if (PostViewState.AdminPageView == PostViewState.AdminPostState.published)
    {
        <Blog.Client.Components.Pages.Components.ManagePosts ListPostFilterByUser="ListPublishedByUser" Pagination="PaginationPublished" Refresh="RefreshPublishedAsync" OnLoadMore="LoadPublishedPostByUserAsync" RefreshFeaturedAsync="RefreshFeaturedAsync" />
    }
    else if (PostViewState.AdminPageView == PostViewState.AdminPostState.draft)
    {
        <Blog.Client.Components.Pages.Components.ManagePosts ListPostFilterByUser="ListDraftByUser" Pagination="PaginationDraft" Refresh="RefreshDraftAsync" OnLoadMore="LoadDraftPostByUserAsync" />
    }
    else if (PostViewState.AdminPageView == PostViewState.AdminPostState.author)
    {
        <Blog.Client.Components.Pages.Admin.Components.Author />
    }
    else if (PostViewState.AdminPageView == PostViewState.AdminPostState.overview)
    {
        <Blog.Client.Components.Pages.Admin.Components.Overview />
    }
</main>



<style>
   
    .hide-scrollbar::-webkit-scrollbar {
        display: none;
    }

    .hide-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
</style>

@code {

    public bool hasrender = false;
    private bool isSubscribedNotificationCount = false;
    private UserProfileDto? userProfile { get; set; } = new UserProfileDto();
    private List<FeaturedPostDto>? featuredPosts { get; set; } = new List<FeaturedPostDto>();
    private PagedResult<PostDto>? recentPost { get; set; } = new PagedResult<PostDto>();
    private PagedResult<PostDto>? ListPublishedByUser { get; set; } = new PagedResult<PostDto>();

    private PagedResult<PostDto>? ListDraftByUser { get; set; } = new PagedResult<PostDto>();


    private UnreadDto? TotalCount { get; set; } = new UnreadDto();
    private ListPaginatedRequest Pagination { get; set; } = new ListPaginatedRequest { PageNumber = 1, PageSize = 10 };
    private ListPaginatedRequest PaginationPublished { get; set; } = new ListPaginatedRequest { PageNumber = 1, PageSize = 9 };
    private ListPaginatedRequest PaginationDraft { get; set; } = new ListPaginatedRequest { PageNumber = 1, PageSize = 10 };
    private HubConnection? _hubConnection;
    private bool _isSubscribedToSignalR = false;

    private List<AuthorDto>? ListAuthors { get; set; } = new List<AuthorDto>();



    private async Task HandleAllAuthorsClickAsync()
    {
        PostViewState.AdminView(PostViewState.AdminPostState.author);


        await JS.InvokeVoidAsync("eval", "document.activeElement.blur()");
    }

    public async Task TopAuthorsAsync()
    {
        var request = await UserClient.GetTopAuthors();
        ListAuthors = request.Value;
    }

    protected override async Task OnInitializedAsync()
    {

        var getUserTask = GetCurrentUser();
        var listFeaturedTask = ListFeatured();
        var loadRecentTask = LoadPublishedPostsAsync();
        var loadPublishedPostByUser = LoadPublishedPostByUserAsync();
        var loadAdminDraftTask = LoadDraftPostByUserAsync();
        var getApprovalTask = GetUnreadNotificationCount();
        var postsignalRTask = PostSignalR.PostInitializeAsync();
        var notificationsignalRTask = NotificationSignalR.NotificationInitializeAsync();
        var topfiveAuthors = TopAuthorsAsync();

        await Task.WhenAll(
            getUserTask,
            listFeaturedTask,
            loadRecentTask,
            loadPublishedPostByUser,
            loadAdminDraftTask,
            getApprovalTask,
            postsignalRTask,
            notificationsignalRTask,
            topfiveAuthors
        );

        if (!_isSubscribedToSignalR)
        {
            SubscribeCountUpdate();
            await SubscribeNoticationCount();
            await SubscribePendingCountAdmin();
        }

        _isSubscribedToSignalR = true;

        hasrender = true;
    }

    public async Task SubscribePendingCountAdmin()
    {
        var CurrentUserId = await AuthStateProvider.GetUserIdAsync();
        NotificationSignalR.OnPendingCountAdmin((Count) =>
        {
            if (TotalCount is not null)
            {
                TotalCount.PendingCount = Count;
                InvokeAsync(StateHasChanged);
            }

        });
    }
    public void SubscribeCountUpdate()
    {
        PostSignalR.OnViewCountUpdate((postId, viewCount) =>
    {
        var post = featuredPosts?.FirstOrDefault(p => p.PostId == postId);
        if (post != null)
        {
            post.ViewCount = viewCount;
            InvokeAsync(StateHasChanged);
        }
    });
    }

    public async Task SubscribeNoticationCount()
    {

        var CurrentUserId = await AuthStateProvider.GetUserIdAsync();

        NotificationSignalR.OnNotificationCount((Count, UserId) =>
        {

            if (TotalCount is not null)
            {
                TotalCount.NotificationCount = Count;
                InvokeAsync(StateHasChanged);
            }

        });


    }

    public async ValueTask DisposeAsync()
    {
        await NotificationSignalR.DisposeAsync();
    }

    public async Task RefreshPublishedAsync()
    {
        PaginationPublished.PageNumber = 1;
        await LoadPublishedPostByUserAsync();
        await LoadDraftPostByUserAsync();

    }
    public async Task RefreshDraftAsync()
    {
        PaginationDraft.PageNumber = 1;
        await LoadPublishedPostByUserAsync();
        await LoadDraftPostByUserAsync();
    }
    public async Task RefreshAsync() => await LoadPublishedPostsAsync();
    public async Task RefreshFeaturedAsync() => await ListFeatured();

    private async Task ListFeatured()
    {
        var featured = await FeaturedClient.ListFeatured();
        featuredPosts = featured.Value ?? new List<FeaturedPostDto>();
    }

    private async Task GetCurrentUser()
    {
        var request = await ClientService.GetCurrentUser();
        userProfile = request.Value;
    }

    private async Task LoadPublishedPostsAsync()
    {
        var recent = await PostClient.ListPublished(Pagination);
        recentPost = recent.Value;
        StateHasChanged();
    }

    private async Task LoadPublishedPostByUserAsync()
    {
        var listForAdmin = await PostClient.ListPublishedByUser(PaginationPublished);
        ListPublishedByUser = listForAdmin.Value;
        StateHasChanged();
    }

    private async Task LoadDraftPostByUserAsync()
    {
        var listDraftForAdmin = await PostClient.ListDraftByUser(PaginationDraft);
        ListDraftByUser = listDraftForAdmin.Value;
        StateHasChanged();
    }

    public async Task HandleReadMore(int? Id)
    {
        await PostInteractionsClient.TrackPostView(Id);
        Navigation.NavigateTo($"viewblogconstruct/{Id}");
        StateHasChanged();
    }

    public async Task GetUnreadNotificationCount()
    {
        var request = await PostAnalyticsClient.GetAdminUnreadTotal();
        TotalCount = request.Value;
        StateHasChanged();
    }
}
