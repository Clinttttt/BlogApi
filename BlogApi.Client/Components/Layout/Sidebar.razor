@rendermode InteractiveServer
@inject GoogleAuthCallbackService GoogleCallback
@inject ICategoryClientService  CategoryClient
@inject ITagClientService TagClient
@inject IJSRuntime JS
@implements IDisposable

<div class="drawer-side z-20">
    <label for="my-drawer-3" aria-label="close sidebar" class="drawer-overlay"></label>
    <aside class="bg-white min-h-screen w-70 p-5 ">

        <div class="mb-6">
            <h3 class="text-xs font-bold uppercase tracking-wider text-gray-600 mb-4">Categories</h3>
            <ul class="space-y-1">
                <li class="flex items-center gap-3 px-3 py-2.5 rounded-lg bg-blue-50 text-blue-600 font-semibold cursor-pointer">
                    <span class="text-xl">💻</span>
                    <span>All Posts</span>
                    <span class="ml-auto bg-blue-600 text-white px-2 py-0.5 rounded-full text-xs font-semibold">@categories?.FirstOrDefault()?.AllPost</span>
                </li>
                @if (categories?.Any() == true && categories is not null)
                {
                    foreach (var category in categories)
                    {
                        <NavLink href="@($"category/{category.Id}")" class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors">
                            <span class="text-xl text-indigo-500">
                                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m8 15 4 4 4-4m0-6-4-4-4 4" />
                                </svg>
                            </span>
                            <span>@category.Name</span>
                            <span class="ml-auto bg-gray-200 px-2 py-0.5 rounded-full text-xs font-semibold">@category.CategoryCount</span>
                        </NavLink>
                    }
                }
                else
                {
                    <li class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors">
                        <span class="text-xl text-indigo-500">
                            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m8 15 4 4 4-4m0-6-4-4-4 4" />
                            </svg>
                        </span>
                        <span>No post yet</span>
                        <span class="ml-auto bg-gray-200 px-2 py-0.5 rounded-full text-xs font-semibold">0</span>
                    </li>
                }

            </ul>
        </div>

        <div class="mb-6 bg-gradient-to-br from-indigo-500 to-purple-600 p-6 rounded-2xl text-white">
            <h3 class="text-xs font-bold uppercase tracking-wider mb-3">Newsletter</h3>
            <p class="text-sm mb-4 opacity-95 leading-relaxed">
                Get the latest posts delivered right to your inbox
            </p>
            <form class="flex flex-col gap-3">
                <input type="email"
                       placeholder="Your email address"
                       class="px-3 py-3 bg-white/20 backdrop-blur-lg border-none rounded-lg text-sm text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50" />
                <button type="submit"
                        class="bg-white text-indigo-600 px-3 py-3 rounded-lg font-semibold hover:-translate-y-0.5 transition-transform">
                    Subscribe
                </button>
            </form>
        </div>

        <div class="mb-6">
            <h3 class="text-xs font-bold uppercase tracking-wider text-gray-600 mb-4">Popular Tags</h3>
            <div class="flex flex-wrap gap-2">
                @if (tags?.Any() == true && tags is not null)
                {
                foreach (var tag in tags)
                    {
                        <span class="bg-gray-200 px-3 py-1.5 rounded-md text-xs font-medium cursor-pointer hover:bg-gray-300 hover:-translate-y-0.5 transition-all">
                           @tag.Name
                        </span>
                    }
                }
                else
                {
                    <h1>No tags yet</h1>
                }

            </div>
        </div>

        <button @onclick="SignInWithGoogle"
                class="cursor-pointer w-full flex items-center justify-center gap-3 px-4 py-2.5 bg-white border border-gray-300 rounded hover:bg-gray-50 hover:border-gray-400 transition-all font-medium text-sm text-gray-700">
            <svg width="18" height="18" viewBox="0 0 18 18">
                <path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z" />
                <path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z" />
                <path fill="#FBBC05" d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707 0-.593.102-1.17.282-1.709V4.958H.957C.347 6.173 0 7.548 0 9c0 1.452.348 2.827.957 4.042l3.007-2.335z" />
                <path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z" />
            </svg>
            <span>Sign in with Google</span>
        </button>
        <div id="hiddenGoogleButton" style="position: absolute; left: -9999px; width: 0; height: 0; overflow: hidden;"></div>
    </aside>
</div>

@code {
    private const string GoogleClientId = "981649586366-fv3d4al1foo7u24bigmuhhhu98uq2fd1.apps.googleusercontent.com";
    private DotNetObjectReference<Sidebar>? _objRef;

    private List<CategoryDto>? categories { get; set; } = new List<CategoryDto>();
    private List<TagDto>? tags { get; set; } = new List<TagDto>();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _objRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("initGoogleAuth", GoogleClientId, _objRef);
            var category = await CategoryClient.GetListing();
            var tag = await TagClient.GetAllTags();
            tags = tag.Value;
            categories = category.Value;
        }
        StateHasChanged();
    }

    private async Task SignInWithGoogle()
    {
        await JS.InvokeVoidAsync("triggerGoogleSignIn");
    }

    [JSInvokable]
    public async Task HandleGoogleCallback(string idToken)
    {
        await GoogleCallback.ProcessLogin(idToken);
        StateHasChanged();
    }

    public void Dispose()
    {
        _objRef?.Dispose();
    }
}